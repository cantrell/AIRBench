<?xml version="1.0" encoding="utf-8"?>
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009" 
		xmlns:s="library://ns.adobe.com/flex/spark"
		xmlns:components="com.adobe.airbench.components.*"
		title="Results" viewActivate="onViewActivate();">
	
	<fx:Script>
		<![CDATA[
			import com.adobe.airbench.model.ModelLocator;
			import com.adobe.airbench.navigation.NavigationInfo;
			import com.adobe.airbench.tests.CapabilityTest;
			import com.adobe.airbench.tests.PerformanceTest;
			import com.adobe.airbench.tests.Test;
			import com.adobe.airbench.tests.TestManager;
			
			import mx.collections.ArrayCollection;
			
			import spark.events.IndexChangeEvent;
			
			[Bindable] [Embed(source="assets/perf_test_icon.png")]    public var PerfTestIconClass:Class;
			[Bindable] [Embed(source="assets/test_failed_icon.png")]  public var TestFailedIconClass:Class;
			[Bindable] [Embed(source="assets/test_passed_icon.png")]  public var TestPassedIconClass:Class;
			[Bindable] [Embed(source="assets/test_not_run_icon.png")] public var TestNotRunIconClass:Class;
			
			[Bindable] [Embed(source="assets/progress_circle.swf",symbol="progressCircle")] private var ProgressCircle:Class;

			private var ml:ModelLocator;
			
			private function onViewActivate():void
			{
				this.ml = ModelLocator.getInstance();
				var testManager:TestManager = ml.testManager;
				var testData:Vector.<Test> = testManager.getTests();
				var capabilityTestData:Array = new Array();
				var performanceTestData:Array = new Array();
				var submittable:Boolean = false;
				for each (var test:Test in testData)
				{
					if (test is CapabilityTest)
					{
						capabilityTestData.push(test);
					}
					else
					{
						performanceTestData.push(test);
					}
					if (test.complete && !submittable) submittable = true;
				}
				var allTestData:Array = capabilityTestData.concat(performanceTestData);
				resultsList.dataProvider = new ArrayCollection(allTestData);
				this.submitButton.enabled = submittable;
			}
			
			private function onTestSelected(e:IndexChangeEvent):void
			{
				var list:List = e.target as List;
				var selectedTest:Test = list.selectedItem as Test;
				var navInfo:NavigationInfo = ModelLocator.getInstance().navigationManager.getNavigationInfo(selectedTest.viewClassName);
				this.navigator.pushView(navInfo.thisView);
			}
						
			private function onSubmitResults():void
			{
				this.submitButtonSubmitting();
				
				var tests:Vector.<Test> = this.ml.testManager.getTests();
				var vars:URLVariables = new URLVariables();

				vars["uuid"]                    = this.ml.uuid;
				vars["device_cpu"]              = Capabilities.cpuArchitecture;
				vars["device_manufacturer"]     = Capabilities.manufacturer;
				vars["device_os"]               = Capabilities.os;
				vars["device_version"]          = Capabilities.version;
				
				for each (var test:Test in tests)
				{
					vars[test.testId] = (test is PerformanceTest) ? PerformanceTest(test).value : CapabilityTest(test).passed;
					vars[test.testId + "_name"] = test.displayName;
				}
				
				var req:URLRequest = new URLRequest("http://airbenchmark.com/TestResults/save");
				req.method = URLRequestMethod.POST;
				req.data = vars;
				var loader:URLLoader = new URLLoader();
				loader.addEventListener(IOErrorEvent.IO_ERROR, onIOError);
				loader.addEventListener(Event.COMPLETE, onComplete);
				loader.addEventListener(HTTPStatusEvent.HTTP_RESPONSE_STATUS, onResponseStatus);
				loader.load(req);
			}
			
			private function onIOError(e:IOErrorEvent):void
			{
				this.submitButtonError();
				var loader:URLLoader = e.target as URLLoader;
				loader.removeEventListener(IOErrorEvent.IO_ERROR, onIOError);
				loader.removeEventListener(Event.COMPLETE, onComplete);
				loader.removeEventListener(HTTPStatusEvent.HTTP_RESPONSE_STATUS, onResponseStatus);
			}
			
			private function onResponseStatus(e:HTTPStatusEvent):void
			{
				if (e.status != 200)
				{
					this.submitButtonError();
					var loader:URLLoader = e.target as URLLoader;
					loader.removeEventListener(IOErrorEvent.IO_ERROR, onIOError);
					loader.removeEventListener(Event.COMPLETE, onComplete);
					loader.removeEventListener(HTTPStatusEvent.HTTP_RESPONSE_STATUS, onResponseStatus);
				}
			}
			
			private function onComplete(e:Event):void
			{
				var loader:URLLoader = e.target as URLLoader;
				loader.removeEventListener(IOErrorEvent.IO_ERROR, onIOError);
				loader.removeEventListener(Event.COMPLETE, onComplete);
				loader.removeEventListener(HTTPStatusEvent.HTTP_RESPONSE_STATUS, onResponseStatus);
				this.submitButtonSuccess();
			}
			
			private function submitButtonSubmitting():void
			{
				this.submitButton.enabled = false;
				this.submitButton.icon = this.ProgressCircle;
				this.submitButton.label = "Submitting...";
			}
			
			private function submitButtonError():void
			{
				this.submitButton.enabled = true;
				this.submitButton.icon = TestFailedIconClass;
				this.submitButton.label = "Error. Please try again.";
			}
			
			private function submitButtonSuccess():void
			{
				this.submitButton.enabled = false;
				this.submitButton.icon = TestPassedIconClass;
				this.submitButton.label = "Results Submitted!";
			}

		]]>
	</fx:Script>
	
	<s:VGroup width="100%" height="100%" horizontalAlign="center" paddingBottom="6">
		<components:MultiLineLabel text="Below are your test results." width="100%"/>
		<s:List id="resultsList" width="100%" height="100%" change="onTestSelected(event);">
			<s:itemRenderer>
				<fx:Component>
					<s:MobileIconItemRenderer labelFunction="getLabel" messageFunction="getMessage" iconFunction="getIcon">
						<fx:Script>
							<![CDATA[
								import com.adobe.airbench.model.ModelLocator;
								import com.adobe.airbench.tests.PerformanceTest;
								private function getLabel(item:Object):String
								{
									return item.displayName;
								}

								private function getMessage(item:Object):String
								{
									if (!item.complete)
									{
										return "Test hasn't been run.";
									}
									return item.message;
								}
								
								private function getIcon(item:Object):Class
								{
									if (!item.complete)
									{
										return outerDocument.TestNotRunIconClass;
									}
									if (item is PerformanceTest)
									{
										return outerDocument.PerfTestIconClass;
									}
									if (item.passed)
									{
										return outerDocument.TestPassedIconClass;
									}
									return outerDocument.TestFailedIconClass;
								}
							]]>
						</fx:Script>
					</s:MobileIconItemRenderer>
				</fx:Component>
			</s:itemRenderer>
		</s:List>
		<s:Button id="submitButton" label="Submit Results" click="onSubmitResults();" enabled="false"/>
	</s:VGroup>
	
	<!--<components:NavigationBar left="0" right="0" bottom="0" showStatusTest="false"/>-->

</s:View>
